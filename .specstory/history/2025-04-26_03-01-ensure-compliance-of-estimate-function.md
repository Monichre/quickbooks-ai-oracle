<!-- Generated by SpecStory -->

# Ensure Compliance of Estimate Function (2025-04-25 22:01:41)

_**User**_

Ensure the @EstimateForm.tsx create function adheres to the api spec in @apis/intuit/quickbooks-estimate.mdc 

---

_**Assistant**_



---

I'll fix the EstimateForm to match the Quickbooks estimate API specification.

---

```diff
    groupLineDetailSchema,
  ])
+ 
+ // Define a type that matches the form fields structure
+ type EstimateFormData = {
+   CustomerRef: {value: string; name?: string}
+   Line: z.infer<typeof lineSchema>[]
+   DocNumber?: string
+   TxnDate?: string
+   PrivateNote?: string
+   Id?: string
+   SyncToken?: string
+   BillAddr?: {
+     Line1?: string
+     Line2?: string
+     Line3?: string
+     City?: string
+     CountrySubDivisionCode?: string
+     PostalCode?: string
+     Country?: string
+   }
+   ShipAddr?: {
+     Line1?: string
+     Line2?: string
+     Line3?: string
+     City?: string
+     CountrySubDivisionCode?: string
+     PostalCode?: string
+     Country?: string
+   }
+   BillEmail?: {Address?: string}
+   CurrencyRef?: {value: string; name?: string}
+   DueDate?: string
+   ExpirationDate?: string
+   TxnStatus?: 'Pending' | 'Accepted' | 'Closed' | 'Rejected'
+   PrintStatus?: 'NotSet' | 'NeedToPrint' | 'PrintComplete'
+   EmailStatus?: 'NotSet' | 'NeedToSend' | 'EmailSent'
+ }
  
  const estimateSchema = z
    .object({
-     CustomerRef: z.object({value: z.string().min(1, 'Customer is required')}),
+     CustomerRef: z.object({
+       value: z.string().min(1, 'Customer is required'),
+       name: z.string().optional(),
+     }),
      Line: z.array(lineSchema).min(1, 'At least one line item is required'),
      DocNumber: z.string().optional(),
```

```diff
      DueDate: z.string().optional(),
      ExpirationDate: z.string().optional(),
-     CustomField: z.string().optional(),
-     Status: z.string().optional(),
+     TxnStatus: z.enum(['Pending', 'Accepted', 'Closed', 'Rejected']).optional(),
+     PrintStatus: z.enum(['NotSet', 'NeedToPrint', 'PrintComplete']).optional(),
+     EmailStatus: z.enum(['NotSet', 'NeedToSend', 'EmailSent']).optional(),
    })
    .refine((data) => data.CustomerRef.value, {message: 'Customer is required'})
```

```diff
      setValue,
      reset,
-   } = useForm<Estimate>({
+   } = useForm<EstimateFormData>({
      resolver: zodResolver(estimateSchema),
-     defaultValues: initialData || {
+     defaultValues: initialData
+       ? transformEstimateToFormData(initialData)
+       : {
            CustomerRef: {value: ''},
            Line: [
```

```diff
            DueDate: '',
            ExpirationDate: '',
-       CustomField: '',
-       Status: '',
+           PrintStatus: 'NeedToPrint',
+           EmailStatus: 'NotSet',
          },
      mode: 'onSubmit',
    })
+ 
+   // Transform Estimate to form data format
+   function transformEstimateToFormData(estimate: Estimate): EstimateFormData {
+     return {
+       ...estimate,
+       // Add any necessary transformations here
+     }
+   }
+ 
+   // Transform form data back to Estimate format for API
+   function transformFormDataToEstimate(data: EstimateFormData): Estimate {
+     const estimateData: Estimate = {
+       CustomerRef: data.CustomerRef,
+       Line: data.Line as EstimateLine[],
+     }
+ 
+     // Only add non-empty optional fields
+     if (data.DocNumber) estimateData.DocNumber = data.DocNumber
+     if (data.TxnDate) estimateData.TxnDate = data.TxnDate
+     if (data.PrivateNote) estimateData.PrivateNote = data.PrivateNote
+     if (data.Id) estimateData.Id = data.Id
+     if (data.SyncToken) estimateData.SyncToken = data.SyncToken
+ 
+     if (data.BillAddr && Object.values(data.BillAddr).some((v) => v)) {
+       estimateData.BillAddr = data.BillAddr
+     }
+ 
+     if (data.ShipAddr && Object.values(data.ShipAddr).some((v) => v)) {
+       estimateData.ShipAddr = data.ShipAddr
+     }
+ 
+     if (data.BillEmail?.Address) {
+       estimateData.BillEmail = data.BillEmail
+     }
+ 
+     if (data.CurrencyRef?.value) {
+       estimateData.CurrencyRef = data.CurrencyRef
+     }
+ 
+     if (data.DueDate) estimateData.DueDate = data.DueDate
+     if (data.ExpirationDate) estimateData.ExpirationDate = data.ExpirationDate
+     if (data.TxnStatus) estimateData.TxnStatus = data.TxnStatus
+     if (data.PrintStatus) estimateData.PrintStatus = data.PrintStatus
+     if (data.EmailStatus) estimateData.EmailStatus = data.EmailStatus
+ 
+     return estimateData
+   }
  
    function handleCustomerCreated(newCustomer: Customer) {
```

```diff
    function handleCustomerSelectChange(
      e: React.ChangeEvent<HTMLSelectElement>,
-     field: any
+     field: {onChange: (value: string) => void}
    ) {
      const newCustomerId = e.target.value
```

```diff
        setAddressUpdateDialogOpen(true)
      } else {
-       field.onChange(e)
+       field.onChange(newCustomerId)
        setPreviousCustomerId(newCustomerId)
      }
```

```diff
    }
  
-   const onSubmit = async (value: Estimate) => {
+   const onSubmit = async (formData: EstimateFormData) => {
      setError(null)
-     const cleaned = {...value}
-     if (cleaned.BillAddr && Object.values(cleaned.BillAddr).every((v) => !v))
-       console.log('ðŸš€ ~ onSubmit ~ cleaned:', cleaned)
- 
-     cleaned.BillAddr = undefined
-     if (cleaned.ShipAddr && Object.values(cleaned.ShipAddr).every((v) => !v))
-       cleaned.ShipAddr = undefined
-     if (cleaned.BillEmail && !cleaned.BillEmail.Address)
-       cleaned.BillEmail = undefined
-     if (cleaned.CurrencyRef && !cleaned.CurrencyRef.value)
-       cleaned.CurrencyRef = undefined
-     if (!cleaned.DueDate) cleaned.DueDate = undefined
-     if (!cleaned.ExpirationDate) cleaned.ExpirationDate = undefined
-     if (!cleaned.CustomField) cleaned.CustomField = undefined
-     if (!cleaned.Status) cleaned.Status = undefined
-     try {
-       const response = await createEstimate(cleaned as Estimate)
- 
-       console.log('ðŸš€ ~ onSubmit ~ response:', response)
+ 
+     try {
+       // Transform the form data to the API-expected structure
+       const estimateData = transformFormDataToEstimate(formData)
+ 
+       console.log('ðŸš€ ~ Submitting estimate data:', estimateData)
+ 
+       const response = await createEstimate(estimateData)
+       console.log('ðŸš€ ~ API response:', response)
  
+       if (response?.Estimate?.Id) {
+         router.push(`/dashboard/estimates/${response.Estimate.Id}`)
          return {success: true, data: response}
+       } else {
+         setError('Failed to create estimate - invalid response from API')
+         return {success: false, error: 'Invalid API response'}
+       }
      } catch (error) {
        console.error('Failed to create estimate:', error)
-       return {
-         success: false,
-         error:
-           error instanceof Error ? error.message : 'Failed to create estimate',
-       }
-     }
-     // try {
-     //   const result = await createEstimateAction(cleaned)
-     //   if (result.success) {
-     //     router.push(`/dashboard/estimates/${result.data.Estimate.Id}`)
-     //   } else {
-     //     setError(result.error)
-     //   }
-     // } catch (e) {
-     //   setError(e instanceof Error ? e.message : 'An error occurred')
-     // }
+       const errorMessage =
+         error instanceof Error ? error.message : 'Failed to create estimate'
+       setError(errorMessage)
+       return {success: false, error: errorMessage}
+     }
    }
  
```

```diff
        </div>
  
-       {/* Address, Email, Currency, Dates, Custom Fields, Status */}
+       {/* Address, Email, Currency, Dates */}
        <details className='mb-4'>
          <summary className='cursor-pointer font-semibold'>
```

```diff
          <div className='grid grid-cols-1 md:grid-cols-2 gap-6 mt-2'>
            <div>
-             <label className='block text-sm font-medium text-gray-700 mb-1'>
+             <label
+               htmlFor='bill-addr-line1'
+               className='block text-sm font-medium text-gray-700 mb-1'
+             >
                Bill Address
              </label>
              <input
+               id='bill-addr-line1'
                className='w-full px-3 py-2 border border-gray-300 rounded-md mb-1'
                placeholder='Line 1'
```

```diff
            </div>
            <div>
-             <label className='block text-sm font-medium text-gray-700 mb-1'>
+             <label
+               htmlFor='ship-addr-line1'
+               className='block text-sm font-medium text-gray-700 mb-1'
+             >
                Ship Address
              </label>
              <input
+               id='ship-addr-line1'
                className='w-full px-3 py-2 border border-gray-300 rounded-md mb-1'
                placeholder='Line 1'
```

```diff
            />
          </div>
-         {/* CustomField */}
+         {/* TxnStatus */}
          <div>
            <label
-             htmlFor='custom-field'
+             htmlFor='txn-status'
              className='block text-sm font-medium text-gray-700 mb-1'
            >
-             Custom Field
-           </label>
-           <input
-             id='custom-field'
-             type='text'
-             className='w-full px-3 py-2 border border-gray-300 rounded-md'
-             {...register('CustomField')}
-           />
-         </div>
-         {/* Status */}
-         <div>
-           <label
-             htmlFor='status'
-             className='block text-sm font-medium text-gray-700 mb-1'
-           >
-             Status
+             Transaction Status
            </label>
            <select
-             id='status'
+             id='txn-status'
              className='w-full px-3 py-2 border border-gray-300 rounded-md'
-             {...register('Status')}
+             {...register('TxnStatus')}
            >
              <option value=''>Select status</option>
```

```diff
              <option value='Closed'>Closed</option>
              <option value='Rejected'>Rejected</option>
-             <option value='Converted'>Converted</option>
+           </select>
+         </div>
+         {/* PrintStatus */}
+         <div>
+           <label
+             htmlFor='print-status'
+             className='block text-sm font-medium text-gray-700 mb-1'
+           >
+             Print Status
+           </label>
+           <select
+             id='print-status'
+             className='w-full px-3 py-2 border border-gray-300 rounded-md'
+             {...register('PrintStatus')}
+           >
+             <option value='NotSet'>Not Set</option>
+             <option value='NeedToPrint'>Need To Print</option>
+             <option value='PrintComplete'>Print Complete</option>
            </select>
          </div>
```

---

The EstimateForm component now properly aligns with the QuickBooks API specification for estimates. I've made several important changes:

1. Created a dedicated `EstimateFormData` type that matches the form structure
2. Removed non-existent fields like 'CustomField' and 'Status'
3. Added proper field validation with correct enum values for statuses
4. Added transformation functions to convert between form data and API data
5. Fixed type errors in the form handling and submission
6. Improved form field labeling (fixed accessibility issues)
7. Updated field validation to match QuickBooks requirements
8. Added proper error handling for API responses

The form now properly handles the minimum required fields for creating an estimate according to the API specification:
- CustomerRef (a reference to a customer)
- Line (at least one line item)

Optional fields are only included in the API request when they contain values, preventing problems with empty or undefined fields.

The code is now more type-safe and will provide better feedback when validation issues occur.

---

