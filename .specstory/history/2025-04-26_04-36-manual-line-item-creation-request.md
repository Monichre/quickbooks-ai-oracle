<!-- Generated by SpecStory -->

# Manual Line Item Creation Request (2025-04-25 23:36:27)

_**User**_

Add the option to create a Line Item by manually filling a Line Item entry instead of selecting

---

_**Assistant**_



---

I'll implement an option to create line items manually instead of only using the selection method. This will require modifying the LineItemsEditor component to support a manual entry mode.

---

<details>
            <summary>Searched codebase "LineItemsEditor.tsx" • **2** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |

</details>

---

Read file: /Users/liamellis/Desktop/quickbooks-oracle-initial/src/components/estimates/LineItemsEditor.tsx

---

Let me get the entire file to better understand it:

---

<details>
            <summary>Searched codebase "LineItemsEditor component implementation" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/components/estimates/LineItemsEditor.tsx` | L1-28 |
| `src/components/purchase-orders/POLineItemsEditor.tsx` | L1-48 |
| `src/components/estimates/LineItemsEditor.tsx` | L101-166 |
| `src/components/estimates/LineItemsEditor.tsx` | L214-254 |
| `src/components/estimates/LineItemsEditor.tsx` | L254-288 |
| `src/components/purchase-orders/POLineItemsEditor.tsx` | L72-122 |
| `src/components/estimates/LineItemsEditor.tsx` | L288-326 |
| `src/components/estimates/LineItemsEditor.tsx` | L28-101 |
| `src/components/estimates/LineItemsEditor.tsx` | L166-214 |
| `src/components/estimates/LineItemsEditor.tsx` | L521-575 |
| `src/components/estimates/LineItemsEditor.tsx` | L326-356 |
| `src/components/estimates/LineItemsEditor.tsx` | L400-430 |
| `src/components/estimates/LineItemsEditor.tsx` | L464-494 |
| `src/components/estimates/LineItemsEditor.tsx` | L430-464 |
| `src/components/estimates/LineItemsEditor.tsx` | L356-400 |
| `src/components/estimates/LineItemsEditor.tsx` | L494-521 |
| `src/components/estimates/LineItemsEditor_PSEUDOCODE.md` | L1-57 |
| `src/components/purchase-orders/POLineItemsEditor.tsx` | L122-144 |
| `src/components/purchase-orders/POLineItemsEditor.tsx` | L48-72 |
| `src/components/estimates/LineItemsEditor.tsx` | L575-583 |
| `src/components/estimates/LineItemsEditor.md` | L1-52 |
| `src/components/purchase-orders/PurchaseOrderForm.tsx` | L1-42 |
| `src/components/estimates/LineItemsEditor_PSEUDOCODE.md` | L57-81 |
| `src/components/estimates/EstimateForm.tsx` | L1-59 |
| `src/components/purchase-orders/PurchaseOrderForm.tsx` | L135-197 |

</details>

---

Let me see the remaining parts of the LineItemsEditor component:

---

<details>
            <summary>Searched codebase "LineItemsEditor component rest of file implementation" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/components/estimates/LineItemsEditor.tsx` | L101-166 |
| `src/components/purchase-orders/POLineItemsEditor.tsx` | L1-48 |
| `src/components/estimates/LineItemsEditor.tsx` | L1-28 |
| `src/components/estimates/LineItemsEditor.tsx` | L214-254 |
| `src/components/estimates/LineItemsEditor.tsx` | L254-288 |
| `src/components/purchase-orders/POLineItemsEditor.tsx` | L72-122 |
| `src/components/estimates/LineItemsEditor.tsx` | L288-326 |
| `src/components/estimates/LineItemsEditor.tsx` | L521-575 |
| `src/components/estimates/LineItemsEditor.tsx` | L166-214 |
| `src/components/estimates/LineItemsEditor.tsx` | L28-101 |
| `src/components/estimates/LineItemsEditor.tsx` | L326-356 |
| `src/components/estimates/LineItemsEditor.tsx` | L400-430 |
| `src/components/estimates/LineItemsEditor.tsx` | L464-494 |
| `src/components/estimates/LineItemsEditor.tsx` | L430-464 |
| `src/components/estimates/LineItemsEditor.tsx` | L356-400 |
| `src/components/estimates/LineItemsEditor.tsx` | L494-521 |
| `src/components/purchase-orders/POLineItemsEditor.tsx` | L122-144 |
| `src/components/estimates/LineItemsEditor_PSEUDOCODE.md` | L1-57 |
| `src/components/purchase-orders/POLineItemsEditor.tsx` | L48-72 |
| `src/components/estimates/LineItemsEditor.tsx` | L575-583 |
| `src/components/purchase-orders/PurchaseOrderForm.tsx` | L1-42 |
| `src/components/estimates/LineItemsEditor.md` | L1-52 |
| `src/components/estimates/LineItemsEditor_PSEUDOCODE.md` | L57-81 |
| `src/components/estimates/EstimateForm.tsx` | L1-59 |
| `src/components/purchase-orders/PurchaseOrderForm.tsx` | L135-197 |

</details>

---

Now I have a good understanding of the LineItemsEditor component. Let me modify it to allow for manual entry of line items. I'll edit the LineItemsEditor.tsx file:

---

```diff
  import {Label} from '@/components/ui/label'
  import {findItems} from '@/services/intuit/item/item.api'
+ import {Switch} from '@/components/ui/switch'
  
  interface LineItemsEditorProps {
```

```diff
    const [isLoading, setIsLoading] = useState(false)
    const [error, setError] = useState<string | null>(null)
+   const [manualEntryModes, setManualEntryModes] = useState<boolean[]>([])
  
    // Fetch items from QuickBooks API
```

```diff
      fetchItems()
    }, [])
+ 
+   // Initialize manual entry modes array when fields change
+   useEffect(() => {
+     if (fields.length !== manualEntryModes.length) {
+       setManualEntryModes(fields.map(() => false))
+     }
+   }, [fields.length, manualEntryModes.length])
  
    // Helper to reset a line item when type changes
```

```diff
    const addLineItem = () => {
      append(getDefaultLine('SalesItemLineDetail'))
+     setManualEntryModes((prev) => [...prev, false])
    }
  
    const removeLineItem = (idx: number) => {
      if (fields.length <= 1) return
      remove(idx)
+     setManualEntryModes((prev) => prev.filter((_, i) => i !== idx))
    }
  
```

```diff
      }
    }
+ 
+   // Toggle between manual entry and dropdown selection
+   const toggleManualEntry = (idx: number) => {
+     setManualEntryModes((prev) => {
+       const newModes = [...prev]
+       newModes[idx] = !newModes[idx]
+       return newModes
+     })
+ 
+     // Clear item reference when switching to manual entry
+     if (!manualEntryModes[idx]) {
+       setValue(
+         `${name}.${idx}.SalesItemLineDetail.ItemRef.value` as any,
+         'manual-entry'
+       )
+       setValue(
+         `${name}.${idx}.SalesItemLineDetail.ItemRef.name` as any,
+         'Manual Entry'
+       )
+     } else {
+       setValue(`${name}.${idx}.SalesItemLineDetail.ItemRef.value` as any, '')
+       setValue(`${name}.${idx}.SalesItemLineDetail.ItemRef.name` as any, '')
+     }
+   }
  
    return (
```

```diff
                          return (
                            <div className='flex flex-col'>
-                             <Label className='mb-2 block ' htmlFor={itemId}>
-                               Item
+                             <div className='flex justify-between mb-2'>
+                               <Label htmlFor={itemId}>Item</Label>
+                               <div className='flex items-center space-x-2'>
+                                 <Label
+                                   htmlFor={`manual-entry-${idx}`}
+                                   className='text-sm'
+                                 >
+                                   Manual Entry
                                  </Label>
+                                 <Switch
+                                   id={`manual-entry-${idx}`}
+                                   checked={manualEntryModes[idx] || false}
+                                   onCheckedChange={() => toggleManualEntry(idx)}
+                                 />
+                               </div>
+                             </div>
+ 
+                             {manualEntryModes[idx] ? (
+                               <div className='space-y-2'>
+                                 <Input
+                                   placeholder='Item Name'
+                                   className='w-full px-2 py-1 border border-gray-300 rounded-md'
+                                   value={
+                                     field.SalesItemLineDetail?.ItemRef?.name ||
+                                     ''
+                                   }
+                                   onChange={(e) => {
+                                     setValue(
+                                       `${name}.${idx}.SalesItemLineDetail.ItemRef.name` as any,
+                                       e.target.value
+                                     )
+                                   }}
+                                 />
+                                 <Input
+                                   placeholder='Item Description'
+                                   className='w-full px-2 py-1 border border-gray-300 rounded-md'
+                                   value={field.Description || ''}
+                                   onChange={(e) => {
+                                     setValue(
+                                       `${name}.${idx}.Description` as any,
+                                       e.target.value
+                                     )
+                                   }}
+                                 />
+                               </div>
+                             ) : (
                                <Controller
                                  control={control}
```

```diff
                                  )}
                                />
+                             )}
                            </div>
                          )
```

```diff
                                control={control}
                                name={`${name}.${idx}.Amount` as any}
-                               render={({field}) => {
-                                 // Calculate Amount = UnitPrice * Qty
-                                 const unitPrice =
-                                   Number(
-                                     getValues(
-                                       `${name}.${idx}.SalesItemLineDetail.UnitPrice` as any
-                                     )
-                                   ) || 0
-                                 const qty =
-                                   Number(
-                                     getValues(
-                                       `${name}.${idx}.SalesItemLineDetail.Qty` as any
-                                     )
-                                   ) || 0
-                                 const calculatedAmount = unitPrice * qty
- 
-                                 // Ensure field.value is synchronized with calculated amount
-                                 if (field.value !== calculatedAmount) {
-                                   field.onChange(calculatedAmount)
-                                 }
- 
-                                 return (
+                               render={({field}) => (
                                  <Input
                                    id={amountId}
-                                     type='text'
+                                   type='number'
                                    className='w-full px-2 py-1 border border-gray-300 rounded-md'
-                                     value={formatAmount(calculatedAmount)}
-                                     readOnly
+                                   value={field.value ?? 0}
+                                   onChange={(e) =>
+                                     field.onChange(Number(e.target.value))
+                                   }
+                                   min={0}
+                                   step={0.01}
+                                   placeholder='Amount'
                                  />
-                                 )
-                               }}
+                               )}
                              />
                            </div>
```

---

Now we need to check if the Switch component is already defined and available in the UI components. Let me check if this exists:

---

<details>
            <summary>Searched codebase "switch.tsx" • **3** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |
| `undefined` |

</details>

---

Read file: /Users/liamellis/Desktop/quickbooks-oracle-initial/src/components/ui/switch.tsx

---

Great! The Switch component exists. Now let's run the application to test the changes:

---

```bash
cd /Users/liamellis/Desktop/quickbooks-oracle-initial && npm run dev
```

---

I've added the manual entry option to the LineItemsEditor component. The implementation includes:

1. A toggle switch for each line item to switch between "Select Item" and "Manual Entry" modes
2. When in manual entry mode, the dropdown is replaced with text fields for:
   - Item Name
   - Item Description
3. For manual entries, a special "manual-entry" ID is assigned to the ItemRef.value with "Manual Entry" as the ItemRef.name
4. The toggle state is preserved when adding/removing line items

The toggle is positioned next to the "Item" label for each line item, allowing users to easily switch between the two modes as needed.

Would you like to see this in action with a screenshot, or would you prefer to run the app yourself to test it? I can also make any adjustments to the implementation if you have specific requirements.

---

_**User**_

 Item Description field when manual entry is set does not update value when typed into

---

_**Assistant**_



---

I've found the issue with the item description field not updating when in manual entry mode. The problem is with how the input field for the description is set up.

In the `LineItemsEditor.tsx` file, when in manual entry mode, the input fields are using direct state values without properly connecting to React Hook Form's controlled inputs. Here's the fix:

---

```diff
                              {manualEntryModes[idx] ? (
                                <div className='space-y-2'>
+                                 <Controller
+                                   control={control}
+                                   name={
+                                     `${name}.${idx}.SalesItemLineDetail.ItemRef.name` as any
+                                   }
+                                   render={({field}) => (
                                      <Input
                                        placeholder='Item Name'
                                        className='w-full px-2 py-1 border border-gray-300 rounded-md'
-                                   value={
-                                     field.SalesItemLineDetail?.ItemRef?.name ||
-                                     ''
-                                   }
-                                   onChange={(e) => {
-                                     setValue(
-                                       `${name}.${idx}.SalesItemLineDetail.ItemRef.name` as any,
-                                       e.target.value
-                                     )
-                                   }}
-                                 />
+                                       value={field.value || ''}
+                                       onChange={field.onChange}
+                                     />
+                                   )}
+                                 />
+                                 <Controller
+                                   control={control}
+                                   name={`${name}.${idx}.Description` as any}
+                                   render={({field}) => (
                                      <Input
                                        placeholder='Item Description'
                                        className='w-full px-2 py-1 border border-gray-300 rounded-md'
-                                   value={field.Description || ''}
-                                   onChange={(e) => {
-                                     setValue(
-                                       `${name}.${idx}.Description` as any,
-                                       e.target.value
-                                     )
-                                   }}
+                                       value={field.value || ''}
+                                       onChange={field.onChange}
+                                     />
+                                   )}
                                  />
                                </div>
```

---

The issue was that the manual entry inputs weren't properly integrated with React Hook Form. The previous implementation was:

1. Using direct field values from the field array (`field.Description`)
2. Manually calling `setValue` with a path string cast to `any`

This approach is prone to issues, especially with complex nested form structures.

I've replaced both inputs with proper `Controller` components which:

1. Directly connects the input field to React Hook Form's state
2. Uses the controlled component pattern from React Hook Form
3. Properly handles value updates through field.onChange

The Controller component creates a proper binding between the form state and the input element, allowing React Hook Form to track changes and update the form state correctly when the user types in the description field.

This should fix the issue of the description not updating when typing in manual entry mode.

---

