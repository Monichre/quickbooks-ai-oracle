---
description: 
globs: 
alwaysApply: false
---
---
description: â€¯LangBase â€œIntuit Ops Squadâ€ â€” Multiâ€‘Agent Blueprint Automate the lifeâ€‘cycle of Intuitâ€¯/â€¯QuickBooks Online documents (Estimateâ€¯â†’â€¯Purchaseâ€¯Orderâ€¯â†’â€¯Invoice).
Each agent lives on LangBase as a Pipe; together they form a faultâ€‘tolerant pipeline that can ingest raw docs/files or live API objects, validate business rules, decide the next state, and fire off the correct QBO mutation.
globs: **/*.ts, **/*.tsx, **/*.js, **/*.jsx
alwaysApply: false
---


# â€¯LangBase â€œIntuit Ops Squadâ€ â€” Multiâ€‘Agent Blueprint

Mission:Â Automate the lifeâ€‘cycle of Intuitâ€¯/â€¯QuickBooks Online documents (Estimateâ€¯â†’â€¯Purchaseâ€¯Orderâ€¯â†’â€¯Invoice).
Each agent lives on LangBase as a Pipe; together they form a faultâ€‘tolerant pipeline that can ingest raw docs/files or live API objects, validate business rules, decide the next state, and fire off the correct QBO mutation.

â¸»

1.â€¯Agent Roster & Responsibilities

#	Agent (Pipe)	Core Prompt / Role	Inputs	Outputs / NextÂ Pipe
A	Documentâ€¯Ingestor	â€œParse any PDF/JSON/HTML/email attachment and normalize to unified TransactionDoc schema.â€	File, Email, QBOÂ webhook	JSONÂ â†’Â B
B	Entityâ€¯Extractor	â€œIdentify DocType (Estimate / PO / Invoice), CustomerRef, VendorRef, LineItems, totals, dates.â€	TransactionDoc	StructuredÂ entitiesÂ â†’Â C
C	Validation & Compliance	â€œCheck required fields (PrefVendorRef, APAccountRef, totals match). Emit `Valid	NeedsFix` verdict and list errors.â€	Entities
D	StateÂ TransitionÂ Decider	Rulesâ€‘based + LLM: â€¢ If Estimate & valid â†’ â€œReadyâ€¯Forâ€¯POâ€ â€¢ If PO & all items received â†’ â€œReadyâ€¯Forâ€¯Bill/Invoiceâ€ â€¢ Else await.	Entities + Validation	TransitionDecision â†’ E/F
E	POÂ Composer	â€œTranslate validated Estimate into QBO PurchaseOrder payload (one per vendor).â€	Entities (Readyâ€¯Forâ€¯PO)	DraftÂ POs JSON â†’ G
F	InvoiceÂ Composer	â€œTranslate validated PO/Bill into QBO Invoice payload.â€	Entities (Readyâ€¯Forâ€¯Bill/Invoice)	DraftÂ Invoices JSON â†’ G
G	QBOÂ Dispatcher	Hit /purchaseorder or /invoice endpoint (minorÂ v=75) with OAuth tokens; retry + backâ€‘off.	Draft payloads	QBO IDsÂ â†’Â H
H	NotificationÂ /Â Commentator	Post Slack / Email update, persist audit log in LangBase MemorySet.	QBO IDs & original doc	â€”

Why split Eâ€¯&â€¯F?Â Keeps logic thin: each composer knows one JSON schema. The Decider handles branching.

â¸»

2.â€¯LangBase Implementation Notes

2.1Â Pipe Skeleton (TypeScript SDK)

// ./pipes/state-decider.ts
export default definePipe({
  name: "State Transition Decider",
  inputSchema: "Entities",
  outputSchema: "TransitionDecision",
  model: "gpt-4o-mini",
  prompt: `
    You are an ops controller for QuickBooks docs.
    Rules:
    1. If DocType == "Estimate" && validation.status=="Valid" -> "ReadyForPO".
    2. If DocType == "PurchaseOrder" && validation.status=="Valid"
       && all LineItems.received == true -> "ReadyForInvoice".
    3. Else -> "Pending".
    Respond as JSON: { "decision": "...", "reason": "..." }
  `
});

Clone the LangBase emailâ€‘agent repo and swap their Decision Maker pipe for this file.

2.2Â Pipe Chain (emailâ€‘agent style)

pipes:
  - id: ingest
    pipe: ./pipes/document-ingestor.ts
  - id: extract
    pipe: ./pipes/entity-extractor.ts
  - id: validate
    pipe: ./pipes/validator.ts
  - id: decide
    pipe: ./pipes/state-decider.ts
  - when:
      source: decide
      field: decision
      equals: ReadyForPO
    then:
      pipe: ./pipes/po-composer.ts
      next: ./pipes/qbo-dispatcher.ts
  - when:
      source: decide
      field: decision
      equals: ReadyForInvoice
    then:
      pipe: ./pipes/invoice-composer.ts
      next: ./pipes/qbo-dispatcher.ts
  - pipe: ./pipes/notifier.ts

Exactly the same controlâ€‘flow DSL the email agent uses; only condition branches differ.

2.3Â MemorySets
	â€¢	TransactionsLogÂ â€” JSON doc, verdict, QBO IDs (auditâ€‘ready).
	â€¢	VendorDirectoryÂ â€” Cache of QBO Vendor IDs & names (used by composer pipes).
	â€¢	AccountDefaultsÂ â€” Persist the default AP account & currency prefs.

2.4Â Connectors & Triggers

Source	Connector	Trigger
QBO Webhooks (Estimate / PO status)	HTTPSâ€¯â†’Â Ingestor	Realâ€‘time
Email (PDF POs from vendors)	IMAP pipe	Poll everyâ€¯5â€¯min
Manual upload (UI)	Signedâ€‘URL	Onâ€‘demand


â¸»

3.â€¯LLM & Tool Choices

Stage	Model	Rationale
Extraction	GPTâ€‘4oâ€‘mini or GeminiÂ 1.5	high recall on semiâ€‘structured docs
Validation (ruleÂ set)	Local TypeScript fn	deterministic, cheap
Decider	GPTâ€‘4oâ€‘mini	simple reasoning + justification
Composers	GPTâ€‘4oâ€‘mini (tempâ€¯0)	pure JSON masonry
Dispatcher	No LLM	API call
Notifier	ClaudeÂ 3Â Haiku (fluent Slack copy)	cheaper chitâ€‘chat

Swap models freely; LangBase Pipes support >30 LLMs.

â¸»

4.â€¯Edgeâ€‘Case Handling
	1.	Missing PrefVendorRefÂ â†’ Validation marks NeedsFix; Notifier pings human.
	2.	Multiâ€‘currencyÂ â†’ Composer injects CurrencyRef from Estimate; Decider ensures exchange rate present.
	3.	Partial receiptsÂ (PO not fully received)Â â†’ Decider remains Pending until webhook shows ReceivedQtyâ€¯=â€¯Qty.
	4.	Rate limitsÂ â†’ Dispatcher batches at 10â€¯req/s; 429 â†’ exponential backâ€‘off with jitter.

â¸»

5.â€¯Metrics & Observability
	â€¢	Each pipe logs latency_ms, tokens, success/fail.
	â€¢	Grafana dashboard fed from LangBaseâ€™s builtâ€‘in metrics endpoint /metrics/prometheus.
	â€¢	Alert if Dispatcher error rateÂ >â€¯1% overÂ 15â€¯min.

â¸»

6.â€¯Next Steps to Prototype
	1.	Fork langbase-examples/ai-email-agent.
	2.	Replace pipes per table above; keep the router and streaming UI.
	3.	Point QBO creds at sandbox; generate a sample Estimate â†’ verify endâ€‘toâ€‘end.
	4.	Add jest tests: extraction accuracy â‰¥â€¯95% on fixture PDFs.
	5.	Harden error paths â†’ ready for production.

â¸»

ğŸ’¡Â Future Enhancements
	â€¢	Reâ€‘pricing agent: suggest vendor alternatives if item cost Î”â€¯>â€¯5%.
	â€¢	Cashâ€‘flow forecaster: ingest POs & vendor terms, project payable schedule.
	â€¢	Generative Insights: weekly Slack digest summarising open POs, blocked invoices, and exceptions.

â¸»

You now have a fullyâ€‘fleshed multiâ€‘agent game plan compatible with LangBaseâ€™s pipe DSLâ€”dropâ€‘in simple for anyone familiar with their email example. Happy automating! ğŸ› ï¸